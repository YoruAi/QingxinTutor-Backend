<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yoru.qingxintutor.mapper.EmailVerificationCodeMapper">
    <!-- 表名 -->
    <sql id="tableName">
        email_verification_code
    </sql>
    <!-- 所有字段（用于 SELECT） -->
    <sql id="allColumns">
        id,
        email,
        code,
        attempt_count,
        expire_time,
        create_time
    </sql>

    <resultMap id="EmailVerificationCodeResultMap" type="com.yoru.qingxintutor.pojo.entity.EmailVerificationCodeEntity">
        <id property="id" column="id"/>
        <result property="email" column="email"/>
        <result property="code" column="code"/>
        <result property="attemptCount" column="attempt_count"/>
        <result property="expireTime" column="expire_time"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <!-- 查询：根据 email 获取验证码记录 -->
    <select id="selectByEmail" resultMap="EmailVerificationCodeResultMap">
        SELECT
        <include refid="allColumns"/>
        FROM
        <include refid="tableName"/>
        WHERE email = #{email}
        LIMIT 1
    </select>

    <!-- 插入或更新（根据 email） -->
    <insert id="upsert">
        INSERT INTO
        <include refid="tableName"/>
        (email, code, attempt_count, expire_time, create_time)
        VALUES (#{email}, #{code}, #{attemptCount}, #{expireTime}, #{createTime})
        ON DUPLICATE KEY UPDATE
        <trim suffixOverrides=",">
            <if test="code != null">
                code = VALUES(code),
            </if>
            <if test="attemptCount != null">
                attempt_count = VALUES(attempt_count),
            </if>
            <if test="expireTime != null">
                expire_time = VALUES(expire_time),
            </if>
            <if test="createTime != null">
                create_time = VALUES(create_time),
            </if>
        </trim>
    </insert>

    <!-- 更新记录（根据 email） -->
    <update id="updateByEmail">
        UPDATE
        <include refid="tableName"/>
        <set>
            <if test="code != null">
                code = #{code},
            </if>
            <if test="attemptCount != null">
                attempt_count = #{attemptCount},
            </if>
            <if test="expireTime != null">
                expire_time = #{expireTime},
            </if>
            <if test="createTime != null">
                create_time = #{createTime},
            </if>
        </set>
        WHERE email = #{email}
    </update>

    <!-- 更新尝试次数 -->
    <update id="updateAttemptCountByEmail">
        UPDATE
        <include refid="tableName"/>
        SET attempt_count = #{attemptCount}
        WHERE email = #{email}
    </update>

    <!-- 删除验证码 -->
    <delete id="deleteByEmail" parameterType="string">
        DELETE FROM
        <include refid="tableName"/>
        WHERE email = #{email}
    </delete>
</mapper>